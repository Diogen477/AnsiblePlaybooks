---
- name: Проверка наличия установленного EDT
  stat:
    path: "{{ edt_install_path }}/{{ edt_version }}"
  register: edt_installed

- name: Установка EDT из локального дистрибутива
  when: not edt_installed.stat.exists
  block:
    - name: Проверка существования директории с установщиками EDT
      stat:
        path: "{{ edt_installers_dir }}"
      register: edt_dir_check

    - name: Ошибка если директория не найдена
      fail:
        msg: |
          Директория с установщиками EDT не найдена: {{ edt_installers_dir }}
          
          Создайте директорию и разместите в ней дистрибутив EDT:
            sudo mkdir -p {{ edt_installers_dir }}
          
          Скачайте дистрибутив с https://releases.1c.ru/project/DevelopmentTools10
          и поместите файл 1c_edt_distr_{{ edt_version }}_*_linux_x86_64.tar.gz
          в директорию {{ edt_installers_dir }}
      when: not edt_dir_check.stat.exists

    - name: Поиск архива дистрибутива EDT
      find:
        paths: "{{ edt_installers_dir }}"
        patterns:
          - "1c_edt_distr_{{ edt_version }}*linux_x86_64.tar.gz"
          - "1c_edt_distr_{{ edt_version }}*.tar.gz"
          - "1c_edt_*{{ edt_version }}*.tar.gz"
        file_type: file
      register: edt_archive_find

    - name: Ошибка если дистрибутив не найден
      fail:
        msg: |
          Дистрибутив EDT версии {{ edt_version }} не найден в {{ edt_installers_dir }}
          
          Скачайте файл с https://releases.1c.ru/project/DevelopmentTools10
          и поместите его в {{ edt_installers_dir }}
          
          Ожидаемое имя файла: 1c_edt_distr_{{ edt_version }}_*_linux_x86_64.tar.gz
          
          Содержимое директории:
          {{ edt_dir_check.stat.exists | ternary('(директория существует, но файл не найден)', '(директория не существует)') }}
      when: edt_archive_find.files | length == 0

    - name: Создание временного каталога
      tempfile:
        state: directory
        suffix: edt_install
      register: edt_temp_dir

    - name: Распаковка дистрибутива EDT
      unarchive:
        src: "{{ edt_archive_find.files[0].path }}"
        dest: "{{ edt_temp_dir.path }}"
        remote_src: yes

    - name: Поиск установщика EDT
      find:
        paths: "{{ edt_temp_dir.path }}"
        patterns: "1ce-installer-cli"
        file_type: file
        recurse: yes
      register: installer_find

    - name: Ошибка если установщик не найден в архиве
      fail:
        msg: "Установщик 1ce-installer-cli не найден в распакованном архиве"
      when: installer_find.files | length == 0

    - name: Запуск установщика EDT
      command:
        cmd: "./1ce-installer-cli install --ignore-hardware-checks"
        chdir: "{{ installer_find.files[0].path | dirname }}"
      args:
        creates: "{{ edt_install_path }}/{{ edt_version }}"

  always:
    - name: Очистка временных файлов
      file:
        path: "{{ edt_temp_dir.path }}"
        state: absent
      when: edt_temp_dir is defined and edt_temp_dir.path is defined

- name: Информация об установке EDT
  debug:
    msg: "1C:EDT {{ edt_version }} установлен в {{ edt_install_path }}/{{ edt_version }}"
  when: edt_installed.stat.exists
