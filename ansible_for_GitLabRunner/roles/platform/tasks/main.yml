---
- name: Проверка наличия установленной платформы 1С
  stat:
    path: "{{ platform_install_path }}/{{ platform_version }}"
  register: platform_installed

- name: Установка платформы 1С из локального дистрибутива
  when: not platform_installed.stat.exists
  block:
    - name: Проверка существования директории с установщиками платформы
      stat:
        path: "{{ platform_installers_dir }}"
      register: platform_dir_check

    - name: Ошибка если директория не найдена
      fail:
        msg: |
          Директория с установщиками платформы не найдена: {{ platform_installers_dir }}
          
          Создайте директорию и разместите в ней дистрибутив:
            sudo mkdir -p {{ platform_installers_dir }}
          
          Скачайте дистрибутив с https://releases.1c.ru/project/Platform83
          и поместите файл в директорию {{ platform_installers_dir }}
      when: not platform_dir_check.stat.exists

    - name: Поиск установщика платформы (.run)
      find:
        paths: "{{ platform_installers_dir }}"
        patterns:
          - "setup-full-{{ platform_version }}*.run"
          - "setup-full-*.run"
        file_type: file
      register: platform_run_find

    - name: Поиск архива платформы (.tar.gz или .zip)
      find:
        paths: "{{ platform_installers_dir }}"
        patterns:
          - "*{{ platform_version }}*.tar.gz"
          - "*{{ platform_version }}*.zip"
          - "server64_8_3_*.zip"
        file_type: file
      register: platform_archive_find
      when: platform_run_find.files | length == 0

    - name: Ошибка если дистрибутив не найден
      fail:
        msg: |
          Дистрибутив платформы 1С версии {{ platform_version }} не найден в {{ platform_installers_dir }}
          
          Скачайте файл с https://releases.1c.ru/project/Platform83
          и поместите его в {{ platform_installers_dir }}
          
          Поддерживаемые форматы:
            - setup-full-{{ platform_version }}*.run (установщик)
            - *{{ platform_version }}*.tar.gz (архив)
            - *{{ platform_version }}*.zip (архив)
      when: >
        platform_run_find.files | length == 0 and
        (platform_archive_find.files is not defined or platform_archive_find.files | length == 0)

    - name: Создание временного каталога
      tempfile:
        state: directory
        suffix: platform_install
      register: platform_temp_dir

    - name: Распаковка архива платформы (tar.gz)
      unarchive:
        src: "{{ platform_archive_find.files[0].path }}"
        dest: "{{ platform_temp_dir.path }}"
        remote_src: yes
      when: >
        platform_run_find.files | length == 0 and
        platform_archive_find.files | length > 0

    - name: Поиск .run установщика в распакованном архиве
      find:
        paths: "{{ platform_temp_dir.path }}"
        patterns: "setup-full-*.run"
        file_type: file
        recurse: yes
      register: unpacked_installer_find
      when: platform_run_find.files | length == 0

    - name: Определение пути к установщику
      set_fact:
        platform_installer_path: >-
          {%- if platform_run_find.files | length > 0 -%}
            {{ platform_run_find.files[0].path }}
          {%- elif unpacked_installer_find.files is defined and unpacked_installer_find.files | length > 0 -%}
            {{ unpacked_installer_find.files[0].path }}
          {%- else -%}
            NOT_FOUND
          {%- endif -%}

    - name: Ошибка если установщик не найден
      fail:
        msg: "Установщик setup-full-*.run не найден ни в директории, ни в архиве"
      when: platform_installer_path == "NOT_FOUND"

    - name: Установка прав на выполнение
      file:
        path: "{{ platform_installer_path }}"
        mode: '0755'

    - name: Запуск установщика платформы
      command:
        cmd: "{{ platform_installer_path }} --mode unattended --enable-components server,server_admin,ws,liberica_jre"
      args:
        creates: "{{ platform_install_path }}/{{ platform_version }}"

  always:
    - name: Очистка временных файлов
      file:
        path: "{{ platform_temp_dir.path }}"
        state: absent
      when: platform_temp_dir is defined and platform_temp_dir.path is defined

- name: Информация об установке платформы
  debug:
    msg: "1C:Platform {{ platform_version }} установлена в {{ platform_install_path }}/{{ platform_version }}"
  when: platform_installed.stat.exists
